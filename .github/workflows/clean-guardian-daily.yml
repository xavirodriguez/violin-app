name: CleanGuardian Daily

on:
  schedule:
    - cron: "15 5 * * *" # 05:15 UTC
  workflow_dispatch:

jobs:
  quality:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run Format Check
        id: format
        run: pnpm run format:check > format.log 2>&1
        continue-on-error: true

      - name: Run Lint Check
        id: lint
        run: pnpm run lint > lint.log 2>&1
        continue-on-error: true

      - name: Run Type Check
        id: typecheck
        run: pnpm run typecheck > typecheck.log 2>&1
        continue-on-error: true

      - name: Run Unit Tests
        id: test_unit
        run: pnpm run test:unit -- --ci > test_unit.log 2>&1
        continue-on-error: true

      - name: Run Coverage Check
        id: coverage
        run: pnpm run test:coverage -- --ci > coverage.log 2>&1
        continue-on-error: true

      - name: Run Architecture Check
        id: arch
        run: pnpm run arch:check > arch.log 2>&1
        continue-on-error: true

      - name: Generate Report
        id: report
        run: |
          echo "# CleanGuardian Daily Report - $(date)" > clean-guardian-report.md
          echo "" >> clean-guardian-report.md
          echo "## Summary" >> clean-guardian-report.md
          echo "" >> clean-guardian-report.md
          echo "* **Formatting:** ${{ steps.format.outcome == 'success' && '✅' || '❌' }}" >> clean-guardian-report.md
          echo "* **Linting:** ${{ steps.lint.outcome == 'success' && '✅' || '❌' }}" >> clean-guardian-report.md
          echo "* **Type Checking:** ${{ steps.typecheck.outcome == 'success' && '✅' || '❌' }}" >> clean-guardian-report.md
          echo "* **Unit Tests:** ${{ steps.test_unit.outcome == 'success' && '✅' || '❌' }}" >> clean-guardian-report.md
          echo "* **Coverage:** ${{ steps.coverage.outcome == 'success' && '✅' || '❌' }}" >> clean-guardian-report.md
          echo "* **Architecture:** ${{ steps.arch.outcome == 'success' && '✅' || '❌' }}" >> clean-guardian-report.md
          echo "" >> clean-guardian-report.md
          echo "## Details" >> clean-guardian-report.md
          echo "" >> clean-guardian-report.md

          echo "<details><summary>Formatting Check</summary>" >> clean-guardian-report.md
          echo "" >> clean-guardian-report.md
          echo '```' >> clean-guardian-report.md
          cat format.log >> clean-guardian-report.md
          echo '```' >> clean-guardian-report.md
          echo "</details>" >> clean-guardian-report.md

          echo "<details><summary>Linting</summary>" >> clean-guardian-report.md
          echo "" >> clean-guardian-report.md
          echo '```' >> clean-guardian-report.md
          cat lint.log >> clean-guardian-report.md
          echo '```' >> clean-guardian-report.md
          echo "</details>" >> clean-guardian-report.md

          echo "<details><summary>Type Checking</summary>" >> clean-guardian-report.md
          echo "" >> clean-guardian-report.md
          echo '```' >> clean-guardian-report.md
          cat typecheck.log >> clean-guardian-report.md
          echo '```' >> clean-guardian-report.md
          echo "</details>" >> clean-guardian-report.md

          echo "<details><summary>Unit Tests</summary>" >> clean-guardian-report.md
          echo "" >> clean-guardian-report.md
          echo '```' >> clean-guardian-report.md
          cat test_unit.log >> clean-guardian-report.md
          echo '```' >> clean-guardian-report.md
          echo "</details>" >> clean-guardian-report.md

          echo "<details><summary>Coverage Check</summary>" >> clean-guardian-report.md
          echo "" >> clean-guardian-report.md
          echo '```' >> clean-guardian-report.md
          cat coverage.log >> clean-guardian-report.md
          echo '```' >> clean-guardian-report.md
          echo "</details>" >> clean-guardian-report.md

          echo "<details><summary>Architecture Check</summary>" >> clean-guardian-report.md
          echo "" >> clean-guardian-report.md
          echo '```' >> clean-guardian-report.md
          cat arch.log >> clean-guardian-report.md
          echo '```' >> clean-guardian-report.md
          echo "</details>" >> clean-guardian-report.md

      - name: Determine overall status
        id: overall_status
        run: |
          if [ "${{ steps.format.outcome }}" == "success" ] && \
             [ "${{ steps.lint.outcome }}" == "success" ] && \
             [ "${{ steps.typecheck.outcome }}" == "success" ] && \
             [ "${{ steps.test_unit.outcome }}" == "success" ] && \
             [ "${{ steps.coverage.outcome }}" == "success" ] && \
             [ "${{ steps.arch.outcome }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

      - name: Upload report artifact
        uses: actions/upload-artifact@v4
        with:
          name: clean-guardian-report
          path: clean-guardian-report.md

      - name: Fail job if any check failed
        if: steps.overall_status.outputs.status == 'failure'
        run: exit 1
